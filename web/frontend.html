<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸ¦‰ Duolingo Memory Engine</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      class MultiscaleContextModel {
        constructor(mu = 0.042, nu = 1.096, N = 100, xi = 0.9, eps_r = 9.0) {
          this.xi = xi;
          this.eps_r = eps_r;
          this.taus = Array.from({ length: N }, (_, i) => mu * Math.pow(nu, i));
          this.strengths = new Array(N).fill(0);
        }

        study(delta, correct) {
          const decay = this.taus.map((tau) => Math.exp(-delta / tau));
          this.strengths = this.strengths.map(
            (s, i) => s * decay[i] + (correct ? this.eps_r : 1.0),
          );
        }

        predict(delta) {
          const decay = this.taus.map((tau) => Math.exp(-delta / tau));
          const strength = this.strengths.reduce(
            (sum, s, i) => sum + s * decay[i],
            0,
          );
          return 1.0 / (1.0 + Math.exp(-this.xi * strength));
        }
      }

      async function predictHalfLife(features) {
        try {
          const res = await fetch("http://localhost:5000/predict", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(features),
          });
          return (await res.json()).h_pred;
        } catch (err) {
          console.error("Prediction error:", err);
          return 2.0;
        }
      }

      function App() {
        const [lang, setLang] = useState("en->es");
        const [posLabel, setPosLabel] = useState("noun");
        const [tense, setTense] = useState("present_indicative");
        const [person, setPerson] = useState("1st_person");
        const [gramNumber, setGramNumber] = useState("singular");
        const [gender, setGender] = useState("masculine");
        const [caseVal, setCaseVal] = useState("nominative");
        const [definiteness, setDefiniteness] = useState("definite");
        const [degree, setDegree] = useState("comparative");
        const [historySeen, setHistorySeen] = useState(23);
        const [historyCorrect, setHistoryCorrect] = useState(13);
        const [timeLagDays, setTimeLagDays] = useState(2.0);
        const [hourOfDay, setHourOfDay] = useState(1.0);
        const [historyMode, setHistoryMode] = useState("fixed");
        const [compareMode, setCompareMode] = useState(false);

        const [mcmP, setMcmP] = useState(0.5);
        const [hPred, setHPred] = useState(2.0);
        const [pPred, setPPred] = useState(0.5);

        const handlePredict = async () => {
          const mcm = new MultiscaleContextModel();

          if (historyMode === "fixed") {
            for (let i = 0; i < historySeen; i++)
              mcm.study(0.5, i < historyCorrect);
          } else {
            [1.0, 2.0, 4.0, 7.0]
              .slice(0, historySeen)
              .forEach((interval, i) =>
                mcm.study(interval, i < historyCorrect),
              );
          }

          const mcmP = mcm.predict(timeLagDays);
          const acc = historyCorrect / Math.max(historySeen, 1);

          const h = await predictHalfLife({
            hour_of_day: hourOfDay,
            time_lag_days: timeLagDays,
            lang,
            mcm_predicted_p: mcmP,
            historical_accuracy: acc,
            history_seen: historySeen,
            history_correct: historyCorrect,
            pos_label: posLabel,
            tense,
            person,
            grammatical_number: gramNumber,
            gender,
            case: caseVal,
            definiteness,
            degree,
          });

          const p = Math.pow(2, -timeLagDays / h);
          setMcmP(mcmP);
          setHPred(h);
          setPPred(p);
        };

        useEffect(() => {
          const maxDays = Math.max(30, hPred * 2.5);
          const days = Array.from(
            { length: 100 },
            (_, i) => (i / 99) * maxDays,
          );
          const recall = days.map((d) => Math.pow(2, -d / hPred));

          const traces = [
            {
              x: days,
              y: recall,
              type: "scatter",
              mode: "lines",
              name: "Your Learner",
              line: { color: "#1cb0f6", width: 3 },
              fill: "tozeroy",
              fillcolor: "rgba(28,176,246,0.08)",
            },
          ];

          if (compareMode) {
            const benchmark = days.map((d) => Math.pow(2, -d / (hPred * 0.5)));
            traces.push({
              x: days,
              y: benchmark,
              type: "scatter",
              mode: "lines",
              name: "Fast Forgetter",
              line: { color: "#ff9600", width: 2, dash: "dash" },
            });
          }

          traces.push({
            x: [timeLagDays],
            y: [pPred],
            type: "scatter",
            mode: "markers",
            name: "Today",
            marker: {
              color: "#58cc02",
              size: 14,
              symbol: "diamond",
              line: { width: 2, color: "white" },
            },
          });

          Plotly.newPlot(
            "chart",
            traces,
            {
              xaxis: { title: "Days Since Last Practice", gridcolor: "#eee" },
              yaxis: {
                title: "Recall Probability",
                range: [0, 1.05],
                tickformat: ".0%",
                gridcolor: "#eee",
              },
              plot_bgcolor: "white",
              paper_bgcolor: "white",
              hovermode: "x unified",
              legend: {
                orientation: "h",
                yanchor: "bottom",
                y: 1.02,
                xanchor: "right",
                x: 1,
              },
              shapes: [
                {
                  type: "line",
                  x0: 0,
                  x1: maxDays,
                  y0: 0.5,
                  y1: 0.5,
                  line: { color: "#ff4b4b", width: 2, dash: "dot" },
                },
              ],
              margin: { t: 40, b: 60, l: 60, r: 40 },
            },
            { responsive: true },
          );
        }, [hPred, pPred, timeLagDays, compareMode]);

        const features = [
          { name: "MCM Baseline", value: 0.45 },
          { name: "Historical Accuracy", value: 0.32 },
          { name: "Time Lag", value: -0.28 },
          { name: "Part of Speech", value: -0.15 },
          { name: "Tense", value: -0.12 },
          { name: "Hour of Day", value: 0.08 },
          { name: "Times Correct", value: 0.06 },
          { name: "Times Wrong", value: -0.05 },
        ];

        const historicalAccuracy = historyCorrect / Math.max(historySeen, 1);
        const daysToThreshold = pPred >= 0.5 ? hPred * Math.log2(2.0) : 0;
        const remaining = Math.max(0, daysToThreshold - timeLagDays);
        const recallStatus =
          pPred >= 0.8
            ? {
                color: "text-green-500",
                bg: "bg-green-50",
                border: "border-green-500",
                label: "Strong",
              }
            : pPred >= 0.5
              ? {
                  color: "text-yellow-500",
                  bg: "bg-yellow-50",
                  border: "border-yellow-500",
                  label: "Fading",
                }
              : {
                  color: "text-red-500",
                  bg: "bg-red-50",
                  border: "border-red-500",
                  label: "Weak",
                };

        return (
          <div className="min-h-screen max-w-7xl mx-auto p-8">
            <h1 className="text-4xl font-bold text-green-500 text-center mb-8">
              ðŸ¦‰ Duolingo Memory Engine
            </h1>

            <div className="bg-white rounded-lg shadow p-6 mb-6">
              <div className="grid grid-cols-4 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Language Track</label>
                  <select value={lang} onChange={(e) => setLang(e.target.value)} className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="en->es">enâ†’es</option>
                    <option value="en->fr">enâ†’fr</option>
                    <option value="en->de">enâ†’de</option>
                    <option value="en->it">enâ†’it</option>
                    <option value="en->pt">enâ†’pt</option>
                    <option value="es->en">esâ†’en</option>
                    <option value="it->en">itâ†’en</option>
                    <option value="pt->en">ptâ†’en</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Part of Speech</label>
                  <select value={posLabel} onChange={(e) => setPosLabel(e.target.value)} className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="noun">Noun</option>
                    <option value="verb_lexical">Verb (lexical)</option>
                    <option value="verb_ser">Verb (ser/estar)</option>
                    <option value="verb_auxiliary">Verb (auxiliary)</option>
                    <option value="verb_modal">Verb (modal)</option>
                    <option value="adjective">Adjective</option>
                    <option value="adverb">Adverb</option>
                    <option value="determiner">Determiner</option>
                    <option value="pronoun">Pronoun</option>
                    <option value="preposition">Preposition</option>
                    <option value="conjunction">Conjunction</option>
                    <option value="proper_noun">Proper Noun</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Tense / Mood</label>
                  <select value={tense} onChange={(e) => setTense(e.target.value)} className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="present_indicative">present_indicative</option>
                    <option value="past_participle">past_participle</option>
                    <option value="infinitive">infinitive</option>
                    <option value="gerund">gerund</option>
                    <option value="preterite">preterite</option>
                    <option value="conditional">conditional</option>
                    <option value="future_indicative">future_indicative</option>
                    <option value="imperative">imperative</option>
                    <option value="past_imperfect_indicative">past_imperfect_indicative</option>
                    <option value="present_subjunctive">present_subjunctive</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Days Since Last Practice: <span className="text-green-500 font-semibold">{timeLagDays.toFixed(1)}</span></label>
                  <input type="range" min="0.1" max="365" step="0.5" value={timeLagDays} onChange={(e) => setTimeLagDays(parseFloat(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-green-500" />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Person</label>
                  <select value={person} onChange={(e) => setPerson(e.target.value)} className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="1st_person">1st_person</option>
                    <option value="2nd_person">2nd_person</option>
                    <option value="3rd_person">3rd_person</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Number</label>
                  <select value={gramNumber} onChange={(e) => setGramNumber(e.target.value)} className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="singular">singular</option>
                    <option value="plural">plural</option>
                    <option value="singular_or_plural">singular_or_plural</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                  <select value={gender} onChange={(e) => setGender(e.target.value)} className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="masculine">masculine</option>
                    <option value="feminine">feminine</option>
                    <option value="neuter">neuter</option>
                    <option value="masculine_or_feminine">masculine_or_feminine</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Hour of Day: <span className="text-green-500 font-semibold">{hourOfDay.toFixed(1)}</span></label>
                  <input type="range" min="0" max="10" step="0.1" value={hourOfDay} onChange={(e) => setHourOfDay(parseFloat(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-green-500" />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Case</label>
                  <select value={caseVal} onChange={(e) => setCaseVal(e.target.value)} className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="nominative">nominative</option>
                    <option value="accusative">accusative</option>
                    <option value="dative">dative</option>
                    <option value="genitive">genitive</option>
                    <option value="vocative">vocative</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Definiteness</label>
                  <select value={definiteness} onChange={(e) => setDefiniteness(e.target.value)} className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="definite">definite</option>
                    <option value="indefinite">indefinite</option>
                    <option value="demonstrative">demonstrative</option>
                    <option value="possessive">possessive</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Adj. Degree</label>
                  <select value={degree} onChange={(e) => setDegree(e.target.value)} className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <option value="comparative">comparative</option>
                    <option value="superlative">superlative</option>
                  </select>
                </div>
                <div className="flex items-center justify-center gap-3">
                  <label className="flex items-center gap-1 cursor-pointer">
                    <input type="radio" checked={historyMode === "fixed"} onChange={() => setHistoryMode("fixed")} className="accent-green-500" />
                    <span className="text-sm">Fixed</span>
                  </label>
                  <label className="flex items-center gap-1 cursor-pointer">
                    <input type="radio" checked={historyMode === "spaced"} onChange={() => setHistoryMode("spaced")} className="accent-green-500" />
                    <span className="text-sm">Spaced</span>
                  </label>
                  <label className="flex items-center gap-1 cursor-pointer">
                    <input type="checkbox" checked={compareMode} onChange={(e) => setCompareMode(e.target.checked)} className="accent-green-500" />
                    <span className="text-sm">Compare</span>
                  </label>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Times Practiced</label>
                  <input type="number" min="1" max="200" value={historySeen} onChange={(e) => { const val = parseInt(e.target.value) || 1; setHistorySeen(val); if (historyCorrect > val) setHistoryCorrect(val); }} className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Times Correct</label>
                  <input type="number" min="0" max={historySeen} value={historyCorrect} onChange={(e) => setHistoryCorrect(Math.min(parseInt(e.target.value) || 0, historySeen))} className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" />
                </div>
                <div className="flex items-center justify-center col-span-2">
                  <button onClick={handlePredict} className="bg-green-500 hover:bg-green-600 text-white font-semibold px-12 py-2 rounded-lg transition">
                    Predict Memory
                  </button>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
              <div
                className={`${recallStatus.bg} ${recallStatus.border} border-2 rounded-lg p-6 text-center`}
              >
                <div className={`text-5xl font-bold ${recallStatus.color}`}>
                  {(pPred * 100).toFixed(1)}%
                </div>
                <div className="text-sm text-gray-600 mt-2">
                  Recall â€” <b>{recallStatus.label}</b>
                </div>
              </div>
              <div className="bg-white border border-gray-200 rounded-lg p-6 text-center">
                <div className="text-xs text-gray-500 uppercase mb-2">
                  Half-Life
                </div>
                <div className="text-3xl font-bold">
                  {hPred.toFixed(2)} days
                </div>
              </div>
              <div className="bg-white border border-gray-200 rounded-lg p-6 text-center">
                <div className="text-xs text-gray-500 uppercase mb-2">
                  MCM Baseline
                </div>
                <div className="text-3xl font-bold">
                  {(mcmP * 100).toFixed(1)}%
                </div>
              </div>
              <div className="bg-white border border-gray-200 rounded-lg p-6 text-center">
                <div className="text-xs text-gray-500 uppercase mb-2">
                  Accuracy
                </div>
                <div className="text-3xl font-bold">
                  {(historicalAccuracy * 100).toFixed(1)}%
                </div>
              </div>
              <div className="bg-white border border-gray-200 rounded-lg p-6 text-center">
                <div className="text-xs text-gray-500 uppercase mb-2">
                  Review In
                </div>
                <div
                  className={`text-2xl font-bold ${pPred >= 0.5 ? "text-blue-500" : "text-red-500"}`}
                >
                  {pPred >= 0.5 ? `~${remaining.toFixed(1)} days` : "Now!"}
                </div>
              </div>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
              <div className="bg-white rounded-lg shadow p-6">
                <div
                  id="chart"
                  style={{ width: "100%", height: "400px" }}
                ></div>
              </div>

              <div className="bg-white rounded-lg shadow p-6">
                <h3 className="text-lg font-semibold mb-4">Feature Impact</h3>
                {features.map((f) => (
                  <div key={f.name} className="flex items-center mb-3">
                    <div className="w-40 text-sm font-medium text-gray-700">
                      {f.name}
                    </div>
                    <div className="flex-1 h-7 bg-gray-100 rounded relative overflow-hidden">
                      <div
                        className={`h-full ${f.value > 0 ? "bg-green-500" : "bg-red-500"}`}
                        style={{
                          width: `${(Math.abs(f.value) / 0.45) * 100}%`,
                        }}
                      ></div>
                    </div>
                    <div
                      className={`w-20 text-right text-sm font-semibold ${f.value > 0 ? "text-green-500" : "text-red-500"}`}
                    >
                      {f.value > 0 ? "+" : ""}
                      {f.value.toFixed(3)}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
